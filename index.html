<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>N√°sobilkov√Ω tr√©ning (jen n√°sobky)</title>
  <style>
    :root{
      --bg: linear-gradient(135deg,#0ea5e9 0%, #8b5cf6 50%, #f43f5e 100%);
      --card: rgba(255,255,255,0.15);
      --card-border: rgba(255,255,255,0.35);
      --text: #0b1020;
      --text-inv: #ffffff;
      --accent: #22c55e;
      --warn: #ef4444;
      --muted: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
    html,body{height:100%;}
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Cantarell, Noto Sans, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text-inv);
      display:flex; align-items:center; justify-content:center;
    }
    .app{
      width:min(880px, 96vw);
      min-height: 92vh;
      display:flex; flex-direction:column; gap:16px; padding:16px;
    }
    header{display:flex; align-items:center; justify-content:space-between}
    h1{font-size: clamp(20px, 5vw, 34px); margin:0; letter-spacing:0.3px}
    .pill{backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border:1px solid var(--card-border); background:var(--card); border-radius:999px; padding:8px 14px; font-weight:600}

    .card{
      flex:1; display:flex; flex-direction:column; justify-content:space-between;
      border: 1px solid var(--card-border); background: var(--card); backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px); border-radius: 24px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    .row{display:flex; gap:12px; align-items:center}
    .grow{flex:1}

    .question{
      text-align:center; font-size: clamp(36px, 12vw, 64px); font-weight:800; letter-spacing:1px;
      padding: 18px 12px; border-radius: 18px; background: rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.25);
      user-select:none;
    }
    .input{
      display:flex; justify-content:center; gap:10px; align-items:center; margin-top:4px;
    }
    .answer{
      min-width: 120px; text-align:center; font-weight:800; font-size: clamp(24px, 8vw, 40px);
      padding: 10px 16px; border-radius: 14px; border:1px dashed rgba(255,255,255,0.45);
      background: rgba(255,255,255,0.12);
    }

    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr); /* v≈ædy 3 sloupce */
      gap:10px;
      margin-top: 12px;
    }
    .btn{
      border:none; color: var(--text-inv); font-weight:800; font-size: clamp(18px, 6vw, 28px); padding: 14px 10px; border-radius: 16px;
      background: rgba(255,255,255,0.14); border:1px solid rgba(255,255,255,0.3); box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      transition: transform .06s ease, filter .2s ease, background .2s ease;
    }
    .btn:active{ transform: translateY(2px) scale(0.98) }
    .btn.small{font-size:14px; font-weight:700; padding:10px 12px; border-radius:12px}

    .ok{ background: rgba(34,197,94,.25); border-color: rgba(34,197,94,.65) }
    .bad{ background: rgba(239,68,68,.28); border-color: rgba(239,68,68,.7) }
    .ghost{ background: rgba(255,255,255,0.08) }

    .bar{ height: 14px; width:100%; background: rgba(255,255,255,0.18); border-radius: 999px; border:1px solid rgba(255,255,255,0.3); overflow:hidden }
    .bar>span{ display:block; height:100%; background: linear-gradient(90deg, #22c55e, #f59e0b); width:0% }

    .stats{
      display:grid; grid-template-columns: repeat(6, 1fr); gap:6px; margin-top:10px;
    }
    .cell{
      text-align:center; padding:6px 0; border-radius: 10px; font-size: 14px; font-weight:700;
      background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.22)
    }
    .cell[data-level="3"]{ background: rgba(34,197,94,.25); border-color: rgba(34,197,94,.6)}
    .cell[data-level="2"]{ background: rgba(250,204,21,.3); border-color: rgba(250,204,21,.7)}
    .cell[data-level="1"]{ background: rgba(239,68,68,.28); border-color: rgba(239,68,68,.7)}

    .footer{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; flex-wrap:wrap }
    .hint{ font-size: 14px; color: var(--muted)}

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px }
    .modal.active{ display:flex }
    .sheet{ width:min(680px, 96vw); background: var(--card); border:1px solid var(--card-border); border-radius: 20px; padding: 16px; backdrop-filter: blur(10px) }
    .sheet h2{ margin: 0 0 10px 0 }
    .field{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0 }
    .range{ width: 60% }

    .flex{ display:flex; gap:8px; align-items:center }
    .sep{ height:1px; background: rgba(255,255,255,0.3); margin:10px 0 }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>‚ú® N√°sobilkov√Ω tr√©ning</h1>
      <div class="flex">
        <button class="pill btn small ghost" id="btnStats">üìà P≈ôehled</button>
        <button class="pill btn small ghost" id="btnSettings">‚öôÔ∏è Nastaven√≠</button>
      </div>
    </header>

    <div class="card">
      <div>
        <div class="row" style="justify-content:space-between">
          <div class="pill" id="modePill">Mix √ó do 10</div>
          <div class="pill" id="streakPill">üî• S√©rie: <span id="streak">0</span></div>
        </div>
        <div class="question" id="question">7 √ó 8 = ?</div>
        <div class="input">
          <div class="answer" id="answer">‚Ä¶</div>
        </div>
        <div class="keypad" id="keypad"></div>
      </div>

      <div class="footer">
        <div class="bar"><span id="progress" style="width:0%"></span></div>
        <div class="hint" id="hint">Tip: Dlouh√© podr≈æen√≠ ‚å´ vyma≈æe cel√© ƒç√≠slo.</div>
      </div>
    </div>

    <div class="modal" id="settingsModal" aria-hidden="true">
      <div class="sheet">
        <h2>‚öôÔ∏è Nastaven√≠</h2>
        <div class="field">
          <label>Maxim√°ln√≠ n√°sobek (1‚Äì12)</label>
          <input type="range" min="4" max="12" value="10" id="maxFactor" class="range">
          <span id="maxFactorVal">10</span>
        </div>
        <div class="field">
          <label>Rychl√Ω re≈æim (ƒçasov√Ω tlak)</label>
          <div class="flex">
            <button class="btn small" data-speed="off">Vypnuto</button>
            <button class="btn small ghost" data-speed="normal">30 s</button>
            <button class="btn small ghost" data-speed="fast">15 s</button>
            <button class="btn small ghost" data-speed="turbo">5 s</button>
          </div>
        </div>
        <div class="field">
          <label>Smƒõrov√°n√≠ p≈ô√≠klad≈Ø</label>
          <div class="flex">
            <button class="btn small" data-order="mix">P≈ôesk√°ƒçku</button>
            <button class="btn small ghost" data-order="single">Jedna tabulka</button>
          </div>
        </div>
        <div class="field" id="singleRow" style="display:none">
          <label>Tabulka (2‚Äì12)</label>
          <input type="range" min="2" max="12" value="5" id="tableOnly" class="range">
          <span id="tableOnlyVal">5</span>
        </div>
        <div class="sep"></div>
        <div class="flex" style="justify-content:space-between">
          <button class="btn small ghost" id="resetProgress">üßΩ Vynulovat pokrok</button>
          <div class="flex">
            <button class="btn small ghost" id="closeSettings">Zav≈ô√≠t</button>
            <button class="btn small" id="saveSettings">Ulo≈æit</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="statsModal" aria-hidden="true">
      <div class="sheet">
        <h2>üìà P≈ôehled & opakov√°n√≠</h2>
        <div class="stats" id="statsGrid"></div>
        <div class="sep"></div>
        <div class="flex" style="justify-content:space-between">
          <div class="hint">Zelen√° = um√≠m, ≈ælut√° = tak tak, ƒçerven√° = procviƒçit.</div>
          <button class="btn small" id="closeStats">Zav≈ô√≠t</button>
        </div>
      </div>
    </div>

  </div>

  <script>
  // --- Pomocn√© funkce ---
  const vibrate = (ms=20)=>{ if ("vibrate" in navigator) try{ navigator.vibrate(ms) }catch(_){} }
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

  // --- Model uƒçen√≠ s opakov√°n√≠m chyb ---
  const STORAGE_KEY = 'mulTrainer.v1';
  const defaultSettings = { maxFactor:10, order:'mix', tableOnly:5, speed:'off' };
  let settings = load('settings') || defaultSettings;
  let state = { a:2,b:3, answer:'', streak:0, lastKey:null, history:[] };

  // v√°hy a statistiky pro p√°ry 1..12
  let weights = load('weights') || initWeights();
  let stats   = load('stats')   || initStats(); // spr√°vnƒõ/≈°patnƒõ, moving score 0..1

  function initWeights(){
    const w={};
    for(let i=1;i<=12;i++) for(let j=i;j<=12;j++) w[key(i,j)] = 1; // jednotn√° v√°ha
    return w;
  }
  function initStats(){
    const s={};
    for(let i=1;i<=12;i++) for(let j=i;j<=12;j++) s[key(i,j)] = {ok:0,bad:0,score:0.5};
    return s;
  }
  function key(a,b){ const [x,y] = a<=b?[a,b]:[b,a]; return `${x}x${y}` }
  function save(name, data){ try{ localStorage.setItem(`${STORAGE_KEY}.${name}`, JSON.stringify(data)) }catch(_){} }
  function load(name){ try{ return JSON.parse(localStorage.getItem(`${STORAGE_KEY}.${name}`)) }catch(_){ return null } }

  // v√Ωbƒõr dal≈°√≠ho p≈ô√≠kladu podle vah + omezen√≠
  function candidates(){
    const max = settings.maxFactor;
    let pairs=[];
    if(settings.order==='single'){
      const t = clamp(+settings.tableOnly,2,12);
      for(let k=1;k<=max;k++){
        const a=t, b=k; if(a*b>0) pairs.push([a,b]);
      }
    } else {
      for(let a=1;a<=max;a++) for(let b=1;b<=max;b++) pairs.push([a,b]);
    }
    return pairs;
  }

  function pickNext(){
    const list = candidates();
    const items = list.map(([a,b])=>({a,b,k:key(a,b),w:weights[key(a,b)]||1}));
    const last = state.history[state.history.length-1];
    const total = items.reduce((s,it)=> s + it.w, 0);

    for(let tries=0; tries<5; tries++){
      let r = Math.random()*total, acc=0, chosen = items[0];
      for(const it of items){ acc += it.w; if(r<=acc){ chosen = it; break; } }
      if(!last || !(last.a===chosen.a && last.b===chosen.b)){
        return {a:chosen.a,b:chosen.b};
      }
    }
    const ch = items[Math.floor(Math.random()*items.length)];
    return {a:ch.a,b:ch.b};
  }

  function updateWeights(a,b, correct){
    const k = key(a,b);
    const w = weights[k] || 1;
    if(correct){
      weights[k] = clamp(w * 0.92, 0.5, 99);
      stats[k].ok++;
      stats[k].score = 0.8*stats[k].score + 0.2*1;
    } else {
      weights[k] = clamp(w + 2.5, 0.5, 99);
      stats[k].bad++;
      stats[k].score = 0.8*stats[k].score + 0.2*0;
    }
    save('weights', weights); save('stats', stats);
  }

  // --- UI logika ---
  const qEl = document.getElementById('question');
  const aEl = document.getElementById('answer');
  const pEl = document.getElementById('progress');
  const streakEl = document.getElementById('streak');
  const keypadEl = document.getElementById('keypad');
  const modePill = document.getElementById('modePill');

  const settingsModal = document.getElementById('settingsModal');
  const statsModal = document.getElementById('statsModal');

  // build keypad ‚Äì stabiln√≠ 3√ó4
  const keys = ['7','8','9',
                '4','5','6',
                '1','2','3',
                '‚å´','0','‚ûú'];

  function renderKeypad(){
    keypadEl.innerHTML = '';
    keys.forEach(k=>{
      const b = document.createElement('button');
      b.className = 'btn';
      b.textContent = k;

      if(k==='‚å´' || k==='‚ûú') b.classList.add('ghost');

      // dlouh√© podr≈æen√≠ Backspace = vymazat v≈°e
      if(k==='‚å´'){
        let hold;
        b.addEventListener('mousedown', ()=>{ hold=setTimeout(()=>{ state.answer=''; aEl.textContent='‚Ä¶'; },500) });
        ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>b.addEventListener(ev,()=>clearTimeout(hold)));
      }
      b.addEventListener('click', ()=>onKey(k));
      keypadEl.appendChild(b);
    });
  }

  function onKey(k){
    if(!k) return;
    vibrate(12);
    if(k==='‚å´'){
      if(state.answer.length>0){ state.answer = state.answer.slice(0,-1) }
      else state.answer='';
      aEl.textContent = state.answer || '‚Ä¶';
      return;
    }
    if(k==='‚ûú'){
      submit();
      return;
    }
    if(/^[0-9]$/.test(k)){
      if(state.answer.length<4){ state.answer += k; aEl.textContent = state.answer }
      return;
    }
  }

  window.addEventListener('keydown', (e)=>{
    if(e.key>='0'&&e.key<='9') onKey(e.key);
    else if(e.key==='Backspace') onKey('‚å´');
    else if(e.key==='Enter') onKey('‚ûú');
  });

  function newTask(){
    const {a,b} = pickNext();
    state.a=a; state.b=b; state.answer='';
    qEl.textContent = `${a} √ó ${b} = ?`;
    aEl.textContent = '‚Ä¶';
    aEl.classList.remove('ok','bad');
    modePill.textContent = settings.order==='single' ? `Tabulka ${settings.tableOnly} √ó do ${settings.maxFactor}` : `Mix √ó do ${settings.maxFactor}`;
    startTimer();
  }

  function submit(){
    const val = parseInt(state.answer||'-999',10);
    const correct = (val === state.a * state.b);
    aEl.classList.remove('ok','bad');
    if(correct){
      aEl.classList.add('ok');
      pEl.style.width = clamp((+pEl.style.width.replace('%','')||0)+4, 0, 100) + '%';
      state.streak++; streakEl.textContent = state.streak;
      vibrate(8);
      updateWeights(state.a, state.b, true);
      state.history.push({a:state.a,b:state.b}); if(state.history.length>30) state.history.shift();
      setTimeout(()=>newTask(), 280);
    } else {
      aEl.classList.add('bad');
      state.streak=0; streakEl.textContent = '0';
      vibrate(60);
      updateWeights(state.a, state.b, false);
      qEl.textContent = `${state.a} √ó ${state.b} = ${state.a*state.b}`;
      setTimeout(()=>newTask(), 650);
    }
  }

  // --- Nastaven√≠ ---
  const maxFactor = document.getElementById('maxFactor');
  const maxFactorVal = document.getElementById('maxFactorVal');
  maxFactor.value = settings.maxFactor; maxFactorVal.textContent = settings.maxFactor;
  maxFactor.oninput = ()=> maxFactorVal.textContent = maxFactor.value;

  const tableOnly = document.getElementById('tableOnly');
  const tableOnlyVal = document.getElementById('tableOnlyVal');
  tableOnly.value = settings.tableOnly; tableOnlyVal.textContent = settings.tableOnly;
  tableOnly.oninput = ()=> tableOnlyVal.textContent = tableOnly.value;

  document.querySelectorAll('[data-order]').forEach(btn=>{
    if(btn.dataset.order===settings.order) btn.classList.remove('ghost'); else btn.classList.add('ghost');
    btn.addEventListener('click',()=>{
      document.querySelectorAll('[data-order]').forEach(b=>b.classList.add('ghost'));
      btn.classList.remove('ghost');
      settings.order = btn.dataset.order;
      document.getElementById('singleRow').style.display = settings.order==='single' ? 'flex' : 'none';
    })
  })
  document.getElementById('singleRow').style.display = settings.order==='single' ? 'flex' : 'none';

  document.querySelectorAll('[data-speed]').forEach(btn=>{
    if(btn.dataset.speed===settings.speed) btn.classList.remove('ghost'); else btn.classList.add('ghost');
    btn.addEventListener('click',()=>{
      document.querySelectorAll('[data-speed]').forEach(b=>b.classList.add('ghost'));
      btn.classList.remove('ghost');
      settings.speed = btn.dataset.speed;
      startTimer();
    })
  })

  document.getElementById('btnSettings').onclick = ()=>{ settingsModal.classList.add('active') }
  document.getElementById('closeSettings').onclick = ()=>{ settingsModal.classList.remove('active') }
  document.getElementById('saveSettings').onclick = ()=>{
    settings.maxFactor = +maxFactor.value; settings.tableOnly = +tableOnly.value;
    save('settings', settings);
    settingsModal.classList.remove('active');
    newTask();
  }
  document.getElementById('resetProgress').onclick = ()=>{
    if(confirm('Opravdu vymazat pokrok?')){
      weights = initWeights(); stats = initStats(); save('weights',weights); save('stats',stats);
      pEl.style.width = '0%'; state.streak=0; streakEl.textContent='0';
      newTask();
    }
  }

  // --- P≈ôehled ---
  const statsGrid = document.getElementById('statsGrid');
  function renderStats(){
    statsGrid.innerHTML='';
    const max = settings.maxFactor;
    const cells = [];
    for(let a=1;a<=max;a++){
      for(let b=1;b<=max;b++){
        const s = stats[key(a,b)] || {score:0.5};
        const lvl = s.score>0.8?3: (s.score>0.55?2:1);
        const cell = document.createElement('div');
        cell.className='cell';
        cell.dataset.level=String(lvl);
        cell.title = `Spr√°vnƒõ: ${s.ok||0}, Chybnƒõ: ${s.bad||0}`;
        cell.textContent = `${a}√ó${b}`;
        cell.addEventListener('click',()=>{
          settings.order='single'; settings.tableOnly=a; save('settings', settings);
          settingsModal.classList.remove('active'); statsModal.classList.remove('active');
          newTask();
        })
        cells.push(cell);
      }
    }
    cells.forEach(c=>statsGrid.appendChild(c));
  }
  document.getElementById('btnStats').onclick = ()=>{ renderStats(); statsModal.classList.add('active') }
  document.getElementById('closeStats').onclick = ()=> statsModal.classList.remove('active')

  // --- ƒåasovaƒç pro rychl√Ω re≈æim ---
  let timerId=null, timeLeft=0;
  function startTimer(){
    if(timerId) { clearInterval(timerId); timerId=null; }
    const mode = settings.speed;
    if(mode==='off') { pEl.style.width='0%'; return; }
    timeLeft = (mode==='turbo'?5:(mode==='fast'?15:30));
    const total=timeLeft;
    pEl.style.width='0%';
    timerId = setInterval(()=>{
      timeLeft--; if(timeLeft<=0){ clearInterval(timerId); timerId=null;
        updateWeights(state.a, state.b, false);
        state.streak=0; streakEl.textContent='0';
        qEl.textContent = `${state.a} √ó ${state.b} = ${state.a*state.b}`;
        aEl.classList.add('bad'); vibrate(60);
        setTimeout(()=>newTask(),650);
        return;
      }
      const pct = Math.round(100*(1-timeLeft/total));
      pEl.style.width = pct + '%';
    }, 1000);
  }

  // --- Start ---
  renderKeypad();
  newTask();
  </script>
</body>
</html>
